name: Deploy n8n workflows

on:
  push:
    branches:
      - main
    paths:
      - 'n8n/workflows/**'
      - '.github/workflows/n8n-deploy.yml'
  workflow_dispatch:
  workflow_call:
    secrets:
      N8N_API_URL:
        required: true
      N8N_API_KEY:
        required: true

jobs:
  deploy:
    name: Sync workflows to n8n
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          set -euo pipefail
          N8N_API_URL='${{ secrets.N8N_API_URL }}'
          N8N_API_KEY='${{ secrets.N8N_API_KEY }}'
          if [ -z "${N8N_API_URL}" ] || [ -z "${N8N_API_KEY}" ]; then
            echo "N8N_API_URL and N8N_API_KEY secrets must be configured." >&2
            exit 1
          fi

      - name: Substitute secrets in workflows
        env:
          INTERVALS_ICU_API_KEY: ${{ secrets.INTERVALS_ICU_API_KEY }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CREDENTIAL_ID: ${{ secrets.TELEGRAM_CREDENTIAL_ID }}
        run: |
          chmod +x .github/scripts/substitute-n8n-secrets.sh
          .github/scripts/substitute-n8n-secrets.sh

      - name: Validate substituted workflows
        run: |
          for file in /tmp/n8n-workflows/*.json; do
            echo "Validating: $(basename $file)"
            jq . "$file" > /dev/null || exit 1
            # Verify no placeholders remain
            if grep -q "YOUR_\|PLACEHOLDER" "$file"; then
              echo "ERROR: Found unsubstituted placeholder in $file"
              exit 1
            fi
          done

      - name: Test n8n connectivity
        run: |
          set -euo pipefail
          N8N_API_URL='${{ secrets.N8N_API_URL }}'
          N8N_API_KEY='${{ secrets.N8N_API_KEY }}'
          echo "Testing connectivity to ${N8N_API_URL%/}/api/v1/workflows..."

          # Test with extended timeout and verbose output on failure
          if ! curl -sS --connect-timeout 30 --max-time 60 -o /dev/null -w '%{http_code}' \
            -H "X-N8N-API-KEY: ${N8N_API_KEY}" \
            "${N8N_API_URL%/}/api/v1/workflows" > /tmp/status 2>/tmp/curl_err; then
            echo "Failed to connect to n8n API:" >&2
            cat /tmp/curl_err >&2
            echo "" >&2
            echo "Possible causes:" >&2
            echo "  - n8n instance not accessible from GitHub Actions (private network/firewall)" >&2
            echo "  - SSL certificate issues" >&2
            echo "  - Incorrect N8N_API_URL secret" >&2
            exit 1
          fi

          status=$(cat /tmp/status)
          if [ "${status}" -ge 400 ]; then
            echo "n8n API returned HTTP ${status} - check N8N_API_KEY secret" >&2
            exit 1
          fi
          echo "Connectivity OK (HTTP ${status})"

      - name: Deploy workflows
        run: |
          set -euo pipefail
          N8N_API_URL='${{ secrets.N8N_API_URL }}'
          N8N_API_KEY='${{ secrets.N8N_API_KEY }}'
          shopt -s nullglob
          # Use substituted files from temporary directory
          files=(/tmp/n8n-workflows/*.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No workflow definitions found under /tmp/n8n-workflows." >&2
            exit 1
          fi

          for file in "${files[@]}"; do
            echo "Deploying ${file}"
            workflow_id=$(jq -r '.id' "${file}")
            if [ -z "${workflow_id}" ] || [ "${workflow_id}" = "null" ]; then
              echo "Workflow file ${file} is missing an id field." >&2
              exit 1
            fi

            update_payload=$(jq -c '{name, active, nodes, connections, settings}' "${file}")
            tmpfile=$(mktemp)

            update_status=$(curl -sS -L --connect-timeout 30 --max-time 120 \
              -o "${tmpfile}" -w '%{http_code}' \
              -X PUT "${N8N_API_URL%/}/api/v1/workflows/${workflow_id}" \
              -H "Content-Type: application/json" \
              -H "X-N8N-API-KEY: ${N8N_API_KEY}" \
              -d "${update_payload}")

            if [ "${update_status}" = "404" ]; then
              create_payload=$(jq -c '{name, active, nodes, connections, settings, meta, tags}' "${file}")
              create_status=$(curl -sS -L --connect-timeout 30 --max-time 120 \
                -o "${tmpfile}" -w '%{http_code}' \
                -X POST "${N8N_API_URL%/}/api/v1/workflows" \
                -H "Content-Type: application/json" \
                -H "X-N8N-API-KEY: ${N8N_API_KEY}" \
                -d "${create_payload}")
              if [ "${create_status}" -ge 300 ]; then
                cat "${tmpfile}" >&2
                exit 1
              fi
              echo "Created workflow ${workflow_id}"
            elif [ "${update_status}" -ge 300 ]; then
              cat "${tmpfile}" >&2
              exit 1
            else
              echo "Updated workflow ${workflow_id}"
            fi

            rm -f "${tmpfile}"
          done
